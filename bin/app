#!/usr/bin/env node

// configuration
process.env.NODE_ENV = process.env.NODE_ENV || 'testing';

var path = require('path');

var Server = require('../server/server.js');
var config = require('konphyg')(path.normalize(__dirname + '/../config'));
var registry = require('../lib/registry');

console.log('Loading ' + process.env.NODE_ENV + ' configuration data');

var cfg = config(process.env.NODE_ENV);

// server setup
registry.configure(cfg)
.then(function () {
    var server = new Server(cfg.app);

    // server components
    var rootRoutes = require('../lib/routes/root.js');
    var packageRoutes = require('../lib/routes/package.js');
    var userRoutes = require('../lib/routes/user.js');

    server.applyRoutes(rootRoutes);
    server.applyRoutes(packageRoutes);
    server.applyRoutes(userRoutes);

    server.start(cfg);
}, function (err) {
    console.log('Error starting connection to DB');
    console.log(err);
}).done();
